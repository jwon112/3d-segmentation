# 학습/검증 분포 차이 분석 결과

## 문제 발견

데이터 로더 검증 결과, **학습과 검증 간에 심각한 분포 차이**가 발견되었습니다.

### 핵심 지표

- **학습 데이터 (패치 기반)**: 평균 포그라운드 비율 **6.12%**
- **검증 데이터 (전체 볼륨)**: 평균 포그라운드 비율 **1.15%**
- **차이**: **4.97%** (약 5.3배 차이)

### 원인 분석

1. **학습 단계**: 
   - `BratsPatchDataset3D`가 포그라운드 중심 샘플링 수행
   - 결과적으로 포그라운드 비율이 높은 패치로 학습
   - 모델이 포그라운드 영역에 집중하여 학습

2. **검증 단계**:
   - 전체 볼륨 사용 (슬라이딩 윈도우 추론)
   - 전체 볼륨에서 배경이 98.85%를 차지
   - 모델이 학습 시 경험하지 못한 극단적인 배경 비율

### 결과

모델이 **배경으로 붕괴(Background Collapse)**:
- 검증 시 모든 예측이 배경(클래스 0)
- Val Dice가 0에 수렴

## 해결 방안

### 즉시 적용 가능한 방법

1. **패치 샘플링 보정**:
   - `min_fg_ratio`를 낮추거나 제거 (현재 0.10은 너무 높음)
   - 랜덤 패치와 포그라운드 중심 패치를 혼합
   - 전체 볼륨 분포에 더 가까운 패치 샘플링

2. **검증 방법 개선**:
   - 검증에서도 패치 기반 평가 추가
   - 전체 볼륨 평가와 패치 평가를 모두 수행

3. **손실 함수 조정**:
   - 클래스 가중치 적용 (배경 가중치 낮춤)
   - Focal Loss 사용 고려

### 장기적 개선

1. **Domain Adaptation 기법**:
   - 학습 데이터와 검증 데이터 분포 정렬
   - AdaBN 또는 다른 domain adaptation 기법

2. **검증 데이터 전처리**:
   - 검증 볼륨에서도 포그라운드 영역 중심 평가
   - Background 영역을 다운샘플링

## 권장 사항

**1단계 (즉시)**: 패치 샘플링 개선
- `min_fg_ratio`를 0.05 또는 0.03으로 낮춤
- 50%는 포그라운드 중심, 50%는 완전 랜덤 샘플링

**2단계**: 검증 방식 개선
- 검증에서도 패치 기반 평가 추가하여 sanity check

**3단계**: 손실 함수 개선
- 클래스 가중치 적용 또는 Focal Loss 도입

## 다음 단계

1. `utils/debug_model_output.py` 실행하여 모델 출력 확인
2. `utils/debug_integrated.py` 실행하여 전체 파이프라인 테스트
3. 발견된 문제에 따라 코드 수정

